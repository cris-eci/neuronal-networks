# AWS SageMaker Deployment Guide
## CIFAR-10 CNN Model - AWS Academy Learner Lab

This guide walks you through deploying your trained CNN model to AWS SageMaker using the AWS Academy Learner Lab environment.

> **CRITICAL:** Your SageMaker Domain **MUST** be configured with **"Public internet only"** network access. If your domain is in VPC-only mode, you will experience connection timeouts and the deployment will fail. See [Changing VPC to Public](#changing-vpc-to-public) if you need to fix this.

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Learner Lab Limitations](#learner-lab-limitations)
3. [Step 2: Start AWS Learner Lab](#step-2-start-aws-learner-lab)
4. [Step 3: Create SageMaker Domain](#step-3-create-sagemaker-domain)
5. [Step 4: Create User Profile](#step-4-create-user-profile)
6. [Step 5: Create Code Editor Space](#step-5-create-code-editor-space)
7. [Step 6: Upload Project Files](#step-6-upload-project-files)
8. [Step 7: Run Deployment Demo](#step-7-run-deployment-demo)
10. [Changing VPC to Public](#changing-vpc-to-public)
11. [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before starting, ensure you have:

- Completed Jupyter notebook (`cnn_assignment.ipynb`)
- Trained CNN model exported (Task 6 cells in the notebook)
- Model package (`model.tar.gz`) generated by the notebook
- Deployment scripts in `sagemaker_scripts/` folder
- AWS Academy Learner Lab access

### Required Files Structure

```
neuronal-networks/
â”œâ”€â”€ cnn_assignment.ipynb              # Your completed notebook
â”œâ”€â”€ model.tar.gz                      # Packaged model for SageMaker
â”œâ”€â”€ cifar10_cnn_model/                # Saved Keras model directory
â”‚   â”œâ”€â”€ saved_model.pb
â”‚   â”œâ”€â”€ variables/
â”‚   â””â”€â”€ ...
â””â”€â”€ sagemaker_scripts/
    â”œâ”€â”€ inference.py                  # SageMaker inference handler
    â””â”€â”€ demo_deployment.py            # Deployment demo script
```

---

## Learner Lab Limitations

**Important:** AWS Academy Learner Labs have IAM restrictions that block certain actions:

| Action | Status | Notes |
|--------|--------|-------|
| Create SageMaker Domain | Allowed | |
| Create Code Editor Space | Allowed | |
| Upload model to S3 | Allowed | |
| Create SageMaker Model | Allowed | |
| **Create Endpoint** | **Blocked** | IAM policy restriction |
| **Create EndpointConfig** | **Blocked** | IAM policy restriction |

**Solution:** Our `demo_deployment.py` script demonstrates the full workflow and tests inference locally, working around the endpoint restriction.

---

## Step 1: Step 2: Start AWS Learner Lab

1. Go to your **AWS Academy** course in Canvas/LMS
2. Click on **Modules** â†’ **Learner Lab**
3. Click **Start Lab** (green button)
4. Wait for the lab status to show **Ready** (takes 1-2 minutes)
5. Click **AWS** (with green dot) to open the AWS Console

> **Note:** Learner Lab sessions last 4 hours. Save your work!

---

## Step 2: Create SageMaker Domain

### 2.1 Navigate to SageMaker

1. In the AWS Console search bar, type **SageMaker**
2. Click **Amazon SageMaker**

### 2.2 Create Domain

1. In the left sidebar, click **Admin configurations** â†’ **Domains**
2. Click **Create domain**
3. Select **Set up for organizations** â†’ Click **Set up**

### 2.3 Configure Domain Details

**Page 1 - Domain details:**
- **Domain name:** `cifar10-cnn-domain` (or any name you prefer)
- **Authentication:** Keep default (Login through IAM)
- Click **Next**

**Page 2 - Roles:**
- Select **Use an existing role**
- **Default execution role:** Select `LabRole` from the dropdown
- Click **Next**

**Page 3 - Applications:**
- **SageMaker Studio:** Select **SageMaker Studio - New**
- **Code Editor:**
  - Enable it
  - Set idle shutdown to **60 minutes**
- Click **Next**

**Page 4 - Network:**

> **THIS IS THE MOST CRITICAL STEP!**

- Select **"Public internet only"** â€” **REQUIRED!**
- Do NOT select "VPC only" - this will cause connection timeouts!
- **VPC:** Select the default VPC
- **Subnets:** Select at least **2 subnets** from different availability zones
- **Security group:** Select the **default** security group
- Click **Next**

> If you already created a domain with VPC-only, you need to delete it and recreate with "Public internet only". See [Changing VPC to Public](#changing-vpc-to-public).

**Page 5 - Review:**
- Review your settings
- Click **Submit**

### 2.4 Wait for Domain Creation

This takes 5-8 minutes. The status will show "Creating" â†’ "InService".

---

## Step 3: Create User Profile

Once the domain is ready (status: **InService**):

1. Click on your domain name
2. Go to the **User profiles** tab
3. Click **Add user**

### Configure User:

- **User profile name:** `student` (or your name)
- **Execution role:** Select `LabRole`
- Click **Next** through all remaining pages
- Click **Submit**

Wait 1-2 minutes for the user profile to be created.

---

## Step 4: Create Code Editor Space

### 4.1 Open SageMaker Studio

1. In your domain, find your user profile
2. Click **Launch** â†’ **Studio**

### 4.2 Create Code Editor Space

1. In SageMaker Studio, look at the left sidebar
2. Click **Applications** (or find "Code Editor" in the home page)
3. Click **Create Code Editor space**

### Configure Space:

- **Name:** `cnn-workspace`
- **Instance type:** `ml.t3.medium` (sufficient for demo deployment)
- **Storage:** Keep default (5 GB)
- Click **Create space**

### 4.3 Run the Space

1. After creation, click **Run space**
2. Wait 2-3 minutes for the space to start
3. When ready, click **Open Code Editor**

> You now have VS Code running in AWS!

---

## Step 5: Upload Project Files

### 5.1 Open File Explorer

In Code Editor (VS Code in browser):
1. Click the **Explorer** icon in the left sidebar
2. You'll see an empty workspace

### 5.2 Upload Files

**Option A: Drag and Drop**
1. Open your local file manager
2. Select these files/folders:
   - `model.tar.gz`
   - `cifar10_cnn_model/` folder (optional, for local testing)
   - `sagemaker_scripts/` folder
3. Drag them into the Code Editor file explorer

**Option B: Using Terminal**
1. Open Terminal: **Terminal** â†’ **New Terminal**
2. Use the upload feature in VS Code

### 5.3 Verify Upload

In the Code Editor terminal:

```bash
ls -la
```

You should see:
```
model.tar.gz
sagemaker_scripts/
```

---

## Step 6: Run Deployment Demo

### 6.1 Install Dependencies

In the Code Editor terminal:

```bash
pip install sagemaker boto3 tensorflow
```

### 6.2 Run the Demo Script

```bash
python sagemaker_scripts/demo_deployment.py
```

### 6.3 Expected Output

```
======================================================================
ðŸš€ CIFAR-10 CNN MODEL - SAGEMAKER DEPLOYMENT
======================================================================

ðŸ“¦ Step 1: Initializing SageMaker session...
   âœ… Region: us-east-1
   âœ… Bucket: sagemaker-us-east-1-XXXXXXXXXXXX
   âœ… Role:   arn:aws:iam::XXXXXXXXXXXX:role/LabRole...

ðŸ“¤ Step 2: Uploading model.tar.gz to S3...
   âœ… S3 Path: s3://sagemaker-us-east-1-XXXX/cifar10-cnn-model/model.tar.gz

ðŸ”§ Step 3: Creating SageMaker TensorFlow Model object...
   âœ… TensorFlow Model object created successfully

ðŸŒ Step 4: Deploying endpoint...
   --------------------------------------------------
   ðŸ“‹ Endpoint Name:    cifar10-cnn-endpoint
   ðŸ“‹ Instance Type:    ml.m5.large
   ðŸ“‹ Instance Count:   1
   ðŸ“‹ Framework:        TensorFlow 2.13
   --------------------------------------------------

   âŒ Endpoint deployment failed: (IAM restriction - expected in Learner Lab)

ðŸ§ª Running LOCAL inference test...
--------------------------------------------------
   âœ… Model loaded: Custom_CNN
   Input shape: (None, 32, 32, 3)
   Output shape: (None, 10)
   Parameters: 4,853,066

   ============================================================
   PREDICTION RESULTS (one sample per class)
   ============================================================

   âœ… Sample 1:
      True class:      airplane
      Predicted class:  airplane
      Confidence:       82.34%
      Top 3:            airplane (82.3%), ship (8.1%), bird (4.2%)

   âœ… Sample 2:
      True class:      automobile
      Predicted class:  automobile
      Confidence:       95.12%
      ...

======================================================================
ðŸ“Š DEPLOYMENT DEMO COMPLETE (with local fallback)
======================================================================

ðŸ“Š Summary:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Component                                â”‚ Status â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ SageMaker Session                        â”‚   âœ…   â”‚
   â”‚ Model uploaded to S3                     â”‚   âœ…   â”‚
   â”‚ SageMaker TensorFlow Model object        â”‚   âœ…   â”‚
   â”‚ Inference script (inference.py)          â”‚   âœ…   â”‚
   â”‚ Local inference test                     â”‚   âœ…   â”‚
   â”‚ Real endpoint deployment                 â”‚   âŒ   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Changing VPC to Public

If your domain was created with "VPC only" network access, you MUST change it to "Public internet only".

**Symptoms of VPC-only domain:**
- Script hangs at "Initializing SageMaker session..."
- Connection timeout errors: `ConnectTimeoutError... sts.us-east-1.amazonaws.com`
- Unable to reach AWS services

### Option 1: Delete and Recreate Domain (Recommended)

1. Go to **SageMaker** â†’ **Admin configurations** â†’ **Domains**
2. Select your domain
3. Delete all **User Profiles** and **Spaces** first
4. Delete the **Domain** itself
5. Wait 5-10 minutes for complete deletion
6. **Recreate** with **"Public internet only"**

### Option 2: Edit Domain Network (May Not Work)

1. Go to domain â†’ **Domain settings** â†’ **Network**
2. Click **Edit**
3. Change to **"Public internet only"**
4. Save changes

> This option may not be available for all domains. If grayed out, use Option 1.

---

## Troubleshooting

### Error: "ConnectTimeoutError" or Script Hangs

```
ConnectTimeoutError... Connect timeout on endpoint URL: sts.us-east-1.amazonaws.com
```

**Cause:** Domain configured with "VPC only" network.
**Solution:** Delete and recreate domain with **"Public internet only"**.

### Error: "AccessDeniedException on CreateEndpointConfig"

```
User is not authorized to perform: sagemaker:CreateEndpointConfig
```

**Cause:** Learner Lab blocks endpoint creation.
**Solution:** Expected behavior! The demo script tests locally instead.

### Error: "No module named 'sagemaker'" or "No module named 'tensorflow'"

```bash
pip install sagemaker boto3 tensorflow
```

### Error: "model.tar.gz not found"

**Solution:** Run the model export cells (Task 6) in the notebook first.

### Script Hangs at "Initializing SageMaker session"

**Cause:** Domain is in VPC-only mode.
**Solution:** Delete and recreate domain with **"Public internet only"**.

### TensorFlow Version Mismatch

If you get version-related errors, ensure:
- The model was saved with a compatible TensorFlow version
- The SageMaker TensorFlow container matches (currently using `2.13`)
- Install the matching version: `pip install tensorflow==2.13`

---

## Clean Up (Important!)

Before ending your lab session:

1. **Stop Code Editor Space:**
   - Go to SageMaker Studio â†’ Applications
   - Find your Code Editor space
   - Click **Stop**

2. **Stop Running Apps:**
   - Check for any running applications
   - Stop all to avoid charges

---

## Summary

| Step | Action | Time |
|------|--------|------|
| 1 | Export model from notebook | 2 min |
| 2 | Start Learner Lab | 2 min |
| 3 | Create SageMaker Domain | 8 min |
| 4 | Create User Profile | 2 min |
| 5 | Create Code Editor Space | 3 min |
| 6 | Upload project files | 2 min |
| 7 | Run deployment demo | 2 min |
| 8 | Capture screenshots | 5 min |
| **Total** | | **~26 min** |

---

## What You Demonstrated

Even with Learner Lab limitations, you successfully:

1. Exported a trained TensorFlow/Keras CNN model
2. Packaged the model for SageMaker deployment
3. Created a SageMaker Domain and User Profile
4. Launched a Code Editor (VS Code) in the cloud
5. Uploaded your trained model to S3
6. Created a SageMaker TensorFlow Model object
7. Tested inference predictions locally

This demonstrates understanding of the full ML deployment pipeline for deep learning models, from training to cloud deployment.
